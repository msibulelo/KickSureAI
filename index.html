// SureKick AI - Smart Prediction Engine with Expanded Markets and Better Accuracy

const API_KEY = '9f0af8032a630bf720551c3c38b78057';
const API_HOST = 'https://v3.football.api-sports.io';
const DAYS_AHEAD = 1; // predict matches 1 day before

async function fetchFixtures() {
  const now = new Date();
  const target = new Date();
  target.setDate(now.getDate() + DAYS_AHEAD);

  const dateStr = target.toISOString().split('T')[0];
  const url = `${API_HOST}/fixtures?date=${dateStr}`;

  const options = {
    method: 'GET',
    headers: {
      'x-apisports-key': API_KEY
    }
  };

  try {
    const res = await fetch(url, options);
    const data = await res.json();
    if (!data.response || data.response.length === 0) {
      document.getElementById('oddsBox').innerHTML = 'No upcoming fixtures.';
      return;
    }
    await generatePredictions(data.response);
  } catch (err) {
    document.getElementById('oddsBox').innerHTML = 'Failed to load predictions.';
    console.error(err);
  }
}

async function fetchTeamStats(teamId) {
  const url = `${API_HOST}/teams/statistics?season=2024&team=${teamId}&league=39`;
  const options = {
    method: 'GET',
    headers: {
      'x-apisports-key': API_KEY
    }
  };
  try {
    const res = await fetch(url, options);
    return await res.json();
  } catch (err) {
    console.error('Failed to fetch team stats', err);
    return null;
  }
}

function determineConfidence(homeWinRate, awayWinRate) {
  const diff = Math.abs(homeWinRate - awayWinRate);
  if (diff > 0.4) return 90;
  if (diff > 0.3) return 85;
  if (diff > 0.2) return 75;
  return 60;
}

async function generatePredictions(fixtures) {
  const container = document.getElementById('oddsBox');
  container.innerHTML = '<h3>SureKick AI Predictions (Tomorrow)</h3>';

  for (const fix of fixtures) {
    const home = fix.teams.home;
    const away = fix.teams.away;

    const homeStats = await fetchTeamStats(home.id);
    const awayStats = await fetchTeamStats(away.id);
    if (!homeStats || !awayStats) continue;

    const homeForm = homeStats.response.form || '';
    const awayForm = awayStats.response.form || '';
    const homeWins = homeForm.split('').filter(c => c === 'W').length;
    const awayWins = awayForm.split('').filter(c => c === 'W').length;

    const homeWinRate = homeWins / homeForm.length || 0;
    const awayWinRate = awayWins / awayForm.length || 0;

    let prediction = '';
    let market = '';
    const confidence = determineConfidence(homeWinRate, awayWinRate);

    if (homeWinRate > awayWinRate + 0.25) {
      prediction = `Double Chance: ${home.name} or Draw`;
      market = 'Double Chance';
    } else if (awayWinRate > homeWinRate + 0.25) {
      prediction = `Double Chance: ${away.name} or Draw`;
      market = 'Double Chance';
    } else if (homeWinRate + awayWinRate > 0.9) {
      prediction = 'Over 2.5 Goals';
      market = 'Total Goals';
    } else {
      prediction = 'Under 2.5 Goals';
      market = 'Total Goals';
    }

    container.innerHTML += `
      <div class='card'>
        âš½ ${home.name} vs ${away.name}<br>
        âœ… Prediction: <strong>${prediction}</strong><br>
        ğŸ“Š Market: <strong>${market}</strong><br>
        ğŸ”¢ Confidence Score: <strong>${confidence}%</strong><br>
        ğŸ—“ï¸ Match Day: ${fix.fixture.date.split('T')[0]}
      </div>
    `;
  }
}

function switchTab(tabId) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
  event.target.classList.add("active");
}

window.onload = () => {
  fetchFixtures();
};
